function SNR_dB = SNRo2(y, fs, f0)
%   SNR_FFT_OUT  利用频谱计算输出信噪比（dB）
%
%   SNR_dB = snr_fft_out(y, fs, f0)
%
%   输入参数：  
%       y   - 输出时域信号（列向量或行向量均可）
%       fs  - 采样频率(Hz)
%       f0  - 目标信号频率(Hz)，即你关心的“有用信号”所在频率
%
%   输出参数：
%       SNR_dB - 按文中公式计算得到的信噪比，单位 dB
%
%   计算步骤对应文中公式：
%   (1) 计算输出信号功率： SP = |x(k)|^2
%       x(k) 为频谱中目标信号频率处的幅度
%   (2) 计算信号+噪声总功率： NN = sum_{i=1}^{N/2} x(i)^2
%   (3) 计算输出信噪比： SNR = 10*log10( SP / (NN - SP) )

% ----------- 基本检查 -----------
if nargin < 3
    error('用法：SNR_dB = snr_fft_out(y, fs, f0)');
end

% 将信号转为列向量，便于后续处理
y = y(:);

% ----------- 1. 计算频谱 -----------
N  = length(y);         % 信号长度
Y  = fft(y);            % N 点 FFT，得到复数频谱
N2 = floor(N/2);        % 只取单边谱（实信号频谱对称）

% 单边幅度谱（此处不做归一化，比例关系在后面会抵消）
X = abs(Y(1:N2));

% 对应的频率坐标（0 ~ fs/2）
f = (0:N2-1) * (fs / N);

% ----------- 2. 找到目标频率点的幅度 x(k) -----------
% 找到距离 f0 最近的频率格点索引 k
[~, k] = min(abs(f - f0));

% 目标信号功率：SP = |x(k)|^2
SP = X(k).^2;

% ----------- 3. 计算总功率 NN -----------
% 根据文中公式：NN = sum_{i=1}^{N/2} x(i)^2
NN = sum(X.^2);

% ----------- 4. 按公式计算 SNR（dB）-----------
% 噪声功率 = 总功率 - 信号功率
noisePower = NN - SP;

if noisePower <= 0
    % 理论上不会为负；若为零或负数，说明信号几乎全是目标分量
    warning('噪声功率 <= 0，SNR 为无穷大或数值不稳定。');
    SNR_dB = Inf;
    return;
end

% SNR = 10 * log10( SP / (NN - SP) )
SNR_dB = 10 * log10( SP / noisePower );
end